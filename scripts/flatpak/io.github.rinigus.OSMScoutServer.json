{
    "app-id": "io.github.rinigus.OSMScoutServer",
    "runtime": "org.kde.Platform",
    "runtime-version": "5.9",
    "sdk": "org.kde.Sdk",
    "command": "osmscout-server",
    "finish-args": [
        "--filesystem=host",
        "--device=dri",
        "--share=ipc",
        "--socket=x11",
        "--socket=wayland",
        "--share=network",
        "--talk-name=org.freedesktop.DBus"
    ],
    "cleanup": ["/include", "/lib/mapnik", "/lib/pkgconfig",
                "/lib/*.a", "/share/doc", "/share/info", "/share/man",
                "/share/stylesheets",
                "/bin/cct", "/bin/cs2cs", "/bin/geod", "/bin/gie", "/bin/invgeod", "/bin/invproj",
                "/bin/kc*", "/bin/libpostal_data", "/bin/lua", "/bin/luac",
                "/bin/mapnik-config", "/bin/marisa*",
                "/bin/marisa-predictive-search", "/bin/marisa-reverse-lookup", "/bin/nad2bin", "/bin/proj",
                "/bin/protoc", "/bin/shapeindex", "/bin/valhalla*"
               ],
    "rename-icon": "harbour-osmscout-server",
    "modules": [
        {
            "name": "marisa",
            "buildsystem": "simple",
            "build-commands": [
                "cd marisa-trie && ./configure --prefix=/app",
                "cd marisa-trie && make -j$(nproc) install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/rinigus/pkg-marisa.git"
                }
            ]
        },
        {
            "name": "libpostal",
            "buildsystem": "simple",
            "build-commands": [
                "cd libpostal && ./bootstrap.sh",
                "cd libpostal && ./configure --prefix=/app --datadir=/app/shared/libpostal/data --disable-data-download",
                "cd libpostal && make -j$(nproc) install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/rinigus/pkg-libpostal.git"
                }
            ]
        },
        {
            "name": "libosmscout",
            "buildsystem": "simple",
            "build-commands": [
                "cmake -DCMAKE_INSTALL_PREFIX:PATH=/app -DBUILD_WITH_OPENMP=OFF -DOSMSCOUT_BUILD_MAP_OPENGL=OFF -DOSMSCOUT_BUILD_IMPORT=OFF -DOSMSCOUT_BUILD_MAP_AGG=OFF -DOSMSCOUT_BUILD_MAP_CAIRO=OFF -DOSMSCOUT_BUILD_MAP_SVG=OFF -DOSMSCOUT_BUILD_MAP_IOSX=OFF -DOSMSCOUT_BUILD_TESTS=OFF -DOSMSCOUT_BUILD_DEMOS=OFF -DOSMSCOUT_BUILD_BINDING_JAVA=OFF -DOSMSCOUT_BUILD_BINDING_CSHARP=OFF -DOSMSCOUT_BUILD_DOC_API=OFF -DOSMSCOUT_BUILD_CLIENT_QT=ON -DOSMSCOUT_BUILD_TOOL_OSMSCOUT2=OFF -DOSMSCOUT_BUILD_TOOL_STYLEEDITOR=OFF -DGPERFTOOLS_USAGE=OFF -DOSMSCOUT_BUILD_TOOL_IMPORT=OFF -DOSMSCOUT_BUILD_TOOL_DUMPDATA=OFF .",
                "make",
                "make install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/rinigus/libosmscout.git",
                    "branch": "sailfish"
                }
            ]
            
        },
        "boost.json",
        {
            "name": "lua",
            "sources": [
                {
                    "type": "archive",
                    "url": "http://www.lua.org/ftp/lua-5.3.2.tar.gz",
                    "sha256": "c740c7bb23a936944e1cc63b7c3c5351a8976d7867c5252c8854f7b2af9da68f"
                },
                {
                    "type": "shell",
                    "commands": [ "mv src/luaconf.h src/luaconf.h.template.in" ]
                },
                /* Patches from the Fedora package */
                {
                    "type": "patch",
                    "path": "lua-5.3.0-autotoolize.patch"
                },
                {
                    "type": "patch",
                    "path": "lua-5.3.0-idsize.patch"
                },
                {
                    "type": "shell",
                    "commands": [ "autoreconf -i" ]
                }
            ]
        },
        {
            "name": "protobuf",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/protocolbuffers/protobuf/releases/download/v3.6.1/protobuf-cpp-3.6.1.tar.gz",
                    "sha256": "b3732e471a9bb7950f090fd0457ebd2536a9ba0891b7f3785919c654fe2a2529"
                }
            ]
        },
        {
            "name": "lz4",
            "subdir": "lib",
            "no-autogen": true,
            "make-args": ["lib"],
            "make-install-args": ["PREFIX=/app"],
            "sources": [
                {
                    "type": "archive",
                    "url": "https://github.com/lz4/lz4/archive/v1.8.3/lz4-1.8.3.tar.gz",
                    "sha256": "33af5936ac06536805f9745e0b6d61da606a1f8b4cc5c04dd3cbaca3b9b4fc43"
                }
            ]
        },
        {
            "name": "valhalla-lite",
            "buildsystem": "simple",
            "build-commands": [
                "cd valhalla && cmake . -DCMAKE_INSTALL_PREFIX:PATH=/app -DBOOST_ROOT=/app -DENABLE_DATA_TOOLS=OFF -DENABLE_PYTHON_BINDINGS=OFF -DENABLE_SERVICES=OFF",
                "cd valhalla && make install"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/rinigus/pkg-valhalla-lite.git"
                }
            ]
            
        },
        {
            "name": "kyoto",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://fallabs.com/kyotocabinet/pkg/kyotocabinet-1.2.77.tar.gz",
                    "sha256": "56899329384cc6f0f1f8aa3f1b41001071ca99c1d79225086a7f3575c0209de6"
                }
            ]
        },
        {
            "name": "microhttp",
            "sources": [
                {
                    "type": "archive",
                    "url": "https://ftp.gnu.org/gnu/libmicrohttpd/libmicrohttpd-0.9.59.tar.gz",
                    "sha256": "9b9ccd7d0b11b0e179f1f58dc2caa3e0c62c8609e1e1dc7dcaadf941b67d923c"
                }
            ]
        },
        {
            "name": "proj",
            "sources": [
                {
                    "type": "archive",
                    "url": "http://download.osgeo.org/proj/proj-5.2.0.tar.gz",
                    "sha256": "ef919499ffbc62a4aae2659a55e2b25ff09cccbbe230656ba71c6224056c7e60"
                }
            ]
        },
        {
            "name": "mapnik",
            "buildsystem": "simple",
            "build-commands": [
                "cd mapnik && patch -p1 < ../rpm/mapnik.twkb.patch && patch -p1 < ../rpm/mapnik.issue3384.patch",
                "cd mapnik && make reset",
                "cd mapnik && ./configure BOOST_INCLUDES=/app/include BOOST_LIBS=/app/lib PROJ_INCLUDES=/app/include PROJ_LIBS=/app/lib INPUT_PLUGINS=\"sqlite,shape\" PREFIX=/app LINKING=shared OPTIMIZATION=2 CPP_TESTS=no CAIRO=no PLUGIN_LINKING=static MEMORY_MAPPED_FILE=no DEMO=no MAPNIK_INDEX=no MAPNIK_RENDER=no",
                "cd mapnik && make install",
                "cd mapnik && cp -r deps/mapbox/variant/include/mapbox /app/include"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/rinigus/pkg-mapnik"
                }
            ]
        },
        {
            "name": "osmscout-server",
            "buildsystem": "simple",
            "build-commands": [
                "ln -s pro/osmscout-server_qtcontrols.pro . || true",
                "qmake PREFIX=/app CONFIG+=\"disable_systemd\" osmscout-server_qtcontrols.pro",
                "make -j$(nproc) install",
                "mkdir -p /app/share/applications",
                "install -D scripts/flatpak/io.github.rinigus.OSMScoutServer.desktop /app/share/applications"
            ],
            "sources": [
                {
                    "type": "dir",
                    "path": "../.."
                }
            ]
        },
        {
            "name": "osmscout-server-fonts",
            "buildsystem": "simple",
            "build-commands": [
                "mkdir /app/share/osmscout-server-fonts",
                "cp -r fonts /app/share/osmscout-server-fonts"
            ],
            "sources": [
                {
                    "type": "git",
                    "url": "https://github.com/rinigus/osmscout-server-fonts.git"
                }
            ]
        }
        
    ]
}
